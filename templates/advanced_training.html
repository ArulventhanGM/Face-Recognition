<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Face Training - ML Optimization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .training-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .training-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .training-card h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border-color);
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }
        
        .status-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .progress-container {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 0.5rem;
            margin: 1rem 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .training-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .control-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .control-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .individual-training {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .student-select {
            margin-bottom: 1rem;
        }
        
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            margin: 1rem 0;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--card-bg);
        }
        
        .file-upload-area.dragover {
            border-color: var(--accent-color);
            background: var(--primary-color-light);
        }
        
        .model-info {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .recommendations {
            background: var(--warning-bg);
            border-left: 4px solid var(--warning-color);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-top: 1rem;
        }
        
        .recommendations ul {
            margin: 0;
            padding-left: 1rem;
        }
        
        .test-recognition {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .recognition-results {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--success-color);
        }
        
        @media (max-width: 768px) {
            .training-dashboard {
                grid-template-columns: 1fr;
            }
            
            .training-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        {% include 'nav.html' %}
        
        <div class="content-wrapper">
            <header class="page-header">
                <h1>
                    <i class="fas fa-brain"></i>
                    Advanced Face Training
                    <small>Machine Learning Optimization</small>
                </h1>
                <p>Train face recognition using advanced ML techniques with SVM, cross-validation, and data augmentation</p>
            </header>

            <!-- Training Status Dashboard -->
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-value" id="total-identities">{{ training_status.num_identities or 0 }}</span>
                    <div class="status-label">Trained Identities</div>
                </div>
                <div class="status-item">
                    <span class="status-value" id="total-samples">{{ training_status.total_samples or 0 }}</span>
                    <div class="status-label">Training Samples</div>
                </div>
                <div class="status-item">
                    <span class="status-value" id="model-type">{{ training_status.model_type or 'None' }}</span>
                    <div class="status-label">Model Type</div>
                </div>
                <div class="status-item">
                    <span class="status-value">
                        {% if training_status.model_trained %}
                            <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        {% else %}
                            <i class="fas fa-times-circle" style="color: var(--error-color);"></i>
                        {% endif %}
                    </span>
                    <div class="status-label">Model Status</div>
                </div>
            </div>

            <!-- Training Controls -->
            <div class="training-controls">
                <div class="control-card">
                    <h3><i class="fas fa-users"></i> Batch Training</h3>
                    <p>Train all students with existing photos using advanced ML</p>
                    <button class="btn btn-primary" onclick="trainAllStudents()">
                        <i class="fas fa-rocket"></i> Train All Students
                    </button>
                </div>
                
                <div class="control-card">
                    <h3><i class="fas fa-cogs"></i> Model Optimization</h3>
                    <p>Optimize classifier with cross-validation and grid search</p>
                    <button class="btn btn-accent" onclick="optimizeModel()">
                        <i class="fas fa-magic"></i> Optimize Model
                    </button>
                </div>
                
                <div class="control-card">
                    <h3><i class="fas fa-sync"></i> Retrain Model</h3>
                    <p>Retrain the model with current training data</p>
                    <button class="btn btn-warning" onclick="retrainModel()">
                        <i class="fas fa-redo"></i> Retrain Model
                    </button>
                </div>
                
                <div class="control-card">
                    <h3><i class="fas fa-chart-line"></i> Training Status</h3>
                    <p>Refresh current training status and metrics</p>
                    <button class="btn btn-info" onclick="refreshStatus()">
                        <i class="fas fa-refresh"></i> Refresh Status
                    </button>
                </div>
            </div>

            <!-- Individual Student Training -->
            <div class="individual-training">
                <h3><i class="fas fa-user-plus"></i> Individual Student Training</h3>
                <p>Add training images for specific students to improve recognition accuracy</p>
                
                <div class="student-select">
                    <label for="student-selector">Select Student:</label>
                    <select id="student-selector" class="form-control">
                        <option value="">Choose a student...</option>
                        {% for student in students %}
                        <option value="{{ student.student_id }}">{{ student.name }} ({{ student.student_id }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="file-upload-area" id="upload-area">
                    <i class="fas fa-cloud-upload-alt fa-3x"></i>
                    <h4>Upload Training Images</h4>
                    <p>Drag and drop multiple images here or click to browse</p>
                    <p><small>Recommended: 3-10 high-quality images with different angles and lighting</small></p>
                    <input type="file" id="training-images" multiple accept="image/*" style="display: none;">
                    <button class="btn btn-secondary" onclick="document.getElementById('training-images').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                </div>
                
                <div id="selected-files"></div>
                
                <button class="btn btn-primary" onclick="trainSelectedStudent()" id="train-btn" disabled>
                    <i class="fas fa-play"></i> Start Training
                </button>
            </div>

            <!-- Model Information -->
            <div class="model-info">
                <h3><i class="fas fa-info-circle"></i> Model Information</h3>
                
                <div class="training-dashboard">
                    <div class="training-card">
                        <h4><i class="fas fa-database"></i> Training Data</h4>
                        <div id="training-data-info">
                            {% if training_status.samples_per_identity %}
                                <ul>
                                {% for identity, count in training_status.samples_per_identity.items() %}
                                    <li>{{ identity }}: {{ count }} samples</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <p>No training data available</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="training-card">
                        <h4><i class="fas fa-sliders-h"></i> Model Settings</h4>
                        <ul>
                            <li>Feature Scaling: {{ "Yes" if training_status.feature_scaling else "No" }}</li>
                            <li>PCA Enabled: {{ "Yes" if training_status.pca_enabled else "No" }}</li>
                            <li>Training Directory: {{ training_status.training_directory or "Not set" }}</li>
                        </ul>
                    </div>
                </div>
                
                <div id="recommendations-section"></div>
            </div>

            <!-- Test Recognition -->
            <div class="test-recognition">
                <h3><i class="fas fa-search"></i> Test Recognition</h3>
                <p>Upload an image to test the current model's recognition accuracy</p>
                
                <div class="file-upload-area">
                    <input type="file" id="test-image" accept="image/*">
                    <button class="btn btn-info" onclick="testRecognition()">
                        <i class="fas fa-eye"></i> Test Recognition
                    </button>
                </div>
                
                <div class="recognition-results" id="test-results"></div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progress-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="progress-title">Processing...</h3>
            </div>
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progress-message">Initializing...</p>
                <div id="progress-details"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        
        // File upload handling
        document.getElementById('training-images').addEventListener('change', handleFileSelect);
        
        // Drag and drop
        const uploadArea = document.getElementById('upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            selectedFiles = files.filter(file => file.type.startsWith('image/'));
            displaySelectedFiles();
            updateTrainButton();
        }
        
        function displaySelectedFiles() {
            const container = document.getElementById('selected-files');
            
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h4>Selected Files:</h4><ul>';
            selectedFiles.forEach((file, index) => {
                html += `<li>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</li>`;
            });
            html += '</ul>';
            
            container.innerHTML = html;
        }
        
        function updateTrainButton() {
            const studentId = document.getElementById('student-selector').value;
            const trainBtn = document.getElementById('train-btn');
            
            trainBtn.disabled = !studentId || selectedFiles.length === 0;
        }
        
        document.getElementById('student-selector').addEventListener('change', updateTrainButton);
        
        // Training functions
        async function trainSelectedStudent() {
            const studentId = document.getElementById('student-selector').value;
            
            if (!studentId || selectedFiles.length === 0) {
                showMessage('Please select a student and upload training images', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', studentId);
            
            selectedFiles.forEach(file => {
                formData.append('training_images', file);
            });
            
            showProgress('Training Student', 'Uploading images and training model...');
            
            try {
                const response = await fetch('/api/advanced_train_student', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideProgress();
                
                if (result.success) {
                    showMessage(`Training completed! ${result.message}`, 'success');
                    refreshStatus();
                    
                    // Clear selection
                    selectedFiles = [];
                    document.getElementById('training-images').value = '';
                    displaySelectedFiles();
                    updateTrainButton();
                } else {
                    showMessage(result.message, 'error');
                }
                
            } catch (error) {
                hideProgress();
                showMessage('Training failed: ' + error.message, 'error');
            }
        }
        
        async function trainAllStudents() {
            if (!confirm('This will train all students using their existing photos. Continue?')) {
                return;
            }
            
            showProgress('Batch Training', 'Training all students with advanced ML...');
            
            try {
                const response = await fetch('/api/train_all_students_advanced', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideProgress();
                
                if (result.success) {
                    showMessage(`Batch training completed! Trained ${result.total_trained} students`, 'success');
                    refreshStatus();
                } else {
                    showMessage(result.message, 'error');
                }
                
            } catch (error) {
                hideProgress();
                showMessage('Batch training failed: ' + error.message, 'error');
            }
        }
        
        async function optimizeModel() {
            if (!confirm('This will optimize the model using cross-validation. This may take several minutes. Continue?')) {
                return;
            }
            
            showProgress('Model Optimization', 'Running cross-validation and grid search...');
            
            try {
                const response = await fetch('/api/optimize_model', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideProgress();
                
                if (result.success) {
                    showMessage(`Model optimization completed! Best accuracy: ${(result.final_accuracy * 100).toFixed(2)}%`, 'success');
                    refreshStatus();
                } else {
                    showMessage(result.message, 'error');
                }
                
            } catch (error) {
                hideProgress();
                showMessage('Model optimization failed: ' + error.message, 'error');
            }
        }
        
        async function retrainModel() {
            if (!confirm('This will retrain the entire model. Continue?')) {
                return;
            }
            
            showProgress('Model Retraining', 'Retraining model with current data...');
            
            try {
                const response = await fetch('/api/retrain_model', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideProgress();
                
                if (result.success) {
                    showMessage('Model retraining completed successfully!', 'success');
                    refreshStatus();
                } else {
                    showMessage(result.message, 'error');
                }
                
            } catch (error) {
                hideProgress();
                showMessage('Model retraining failed: ' + error.message, 'error');
            }
        }
        
        async function refreshStatus() {
            try {
                const response = await fetch('/api/get_training_status');
                const result = await response.json();
                
                if (result.success) {
                    updateStatusDisplay(result.status);
                    showMessage('Status refreshed successfully', 'success');
                } else {
                    showMessage('Failed to refresh status', 'error');
                }
                
            } catch (error) {
                showMessage('Status refresh failed: ' + error.message, 'error');
            }
        }
        
        async function testRecognition() {
            const fileInput = document.getElementById('test-image');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showMessage('Please select an image to test', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('test_image', fileInput.files[0]);
            
            showProgress('Testing Recognition', 'Analyzing image...');
            
            try {
                const response = await fetch('/api/test_advanced_recognition', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideProgress();
                
                displayTestResults(result);
                
            } catch (error) {
                hideProgress();
                showMessage('Recognition test failed: ' + error.message, 'error');
            }
        }
        
        function displayTestResults(result) {
            const container = document.getElementById('test-results');
            
            if (!result.success) {
                container.innerHTML = `<div class="result-item" style="border-color: var(--error-color);">
                    <strong>Error:</strong> ${result.message}
                </div>`;
                return;
            }
            
            let html = `<h4>Recognition Results (${result.faces_detected} faces detected)</h4>`;
            
            if (result.results && result.results.length > 0) {
                result.results.forEach((face, index) => {
                    html += `<div class="result-item">
                        <strong>Face ${index + 1}:</strong> ${face.identity}<br>
                        <strong>Confidence:</strong> ${(face.confidence * 100).toFixed(2)}%<br>
                        <strong>Position:</strong> x:${face.bbox[0]}, y:${face.bbox[1]}, w:${face.bbox[2]}, h:${face.bbox[3]}
                    </div>`;
                });
            } else {
                html += '<div class="result-item">No faces recognized with sufficient confidence</div>';
            }
            
            container.innerHTML = html;
        }
        
        function updateStatusDisplay(status) {
            document.getElementById('total-identities').textContent = status.num_identities || 0;
            document.getElementById('total-samples').textContent = status.total_samples || 0;
            document.getElementById('model-type').textContent = status.model_type || 'None';
            
            // Update recommendations
            const recommendationsSection = document.getElementById('recommendations-section');
            if (status.validation && status.validation.recommendations && status.validation.recommendations.length > 0) {
                let html = '<div class="recommendations"><h4><i class="fas fa-lightbulb"></i> Recommendations</h4><ul>';
                status.validation.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul></div>';
                recommendationsSection.innerHTML = html;
            } else {
                recommendationsSection.innerHTML = '';
            }
        }
        
        // Utility functions
        function showProgress(title, message) {
            document.getElementById('progress-title').textContent = title;
            document.getElementById('progress-message').textContent = message;
            document.getElementById('progress-modal').style.display = 'flex';
        }
        
        function hideProgress() {
            document.getElementById('progress-modal').style.display = 'none';
        }
        
        function showMessage(message, type) {
            // Create temporary message element
            const messageEl = document.createElement('div');
            messageEl.className = `alert alert-${type}`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '20px';
            messageEl.style.right = '20px';
            messageEl.style.zIndex = '9999';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 5000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
        });
    </script>
</body>
</html>
