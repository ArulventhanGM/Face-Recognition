{% extends "base.html" %}

{% block title %}Asset Training Dashboard{% endblock %}

{% block extra_css %}
<style>
.training-card {
    min-height: 400px;
}

.progress-section {
    display: none;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 15px 0;
}

.result-section {
    display: none;
    padding: 20px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    margin: 15px 0;
}

.error-section {
    display: none;
    padding: 20px;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    margin: 15px 0;
}

.metric-card {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 10px 0;
}

.metric-number {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    display: block;
}

.metric-label {
    color: #666;
    font-size: 0.9rem;
}

.accuracy-meter {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.accuracy-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
    transition: width 0.5s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-robot"></i> Asset Training Dashboard
                <small class="text-muted">Train face recognition with large datasets</small>
            </h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Real Images</h5>
                            <h2 class="mb-0">{{ "{:,}".format(stats.real_images) }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">AI Images</h5>
                            <h2 class="mb-0">{{ "{:,}".format(stats.ai_images) }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Images</h5>
                            <h2 class="mb-0">{{ "{:,}".format(stats.total_images) }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-images fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Ready to Train</h5>
                            <p class="mb-0">{{ stats.assets_folder }}</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Configuration and Progress -->
    <div class="row">
        <div class="col-md-6">
            <div class="card training-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Training Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="trainingForm">
                        <div class="form-group">
                            <label for="max_images">Maximum Images to Process</label>
                            <input type="number" class="form-control" id="max_images" name="max_images" value="100" min="1" max="1000">
                            <small class="form-text text-muted">Start with 50-100 for testing, use 200-500 for comprehensive training</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Image Types to Include</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use_real_images" name="use_real_images" checked>
                                <label class="form-check-label" for="use_real_images">
                                    <i class="fas fa-user text-primary"></i> Real Human Images ({{ "{:,}".format(stats.real_images) }} available)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use_ai_images" name="use_ai_images">
                                <label class="form-check-label" for="use_ai_images">
                                    <i class="fas fa-robot text-info"></i> AI-Generated Images ({{ "{:,}".format(stats.ai_images) }} available)
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Training Process:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Extracts face features from selected images</li>
                                <li>Adds face data to the recognition model</li>
                                <li>Improves accuracy with diverse face samples</li>
                                <li>Progress and results shown in real-time</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg" id="trainButton">
                            <i class="fas fa-play"></i> Start Training
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="statusButton">
                            <i class="fas fa-info"></i> Check Status
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card training-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Training Progress & Results
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Initial Status -->
                    <div id="initialStatus" class="text-center">
                        <i class="fas fa-play-circle fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Ready to Start Training</h5>
                        <p class="text-muted">Configure your settings and click "Start Training"</p>
                    </div>
                    
                    <!-- Progress Section -->
                    <div id="progressSection" class="progress-section">
                        <div class="text-center mb-3">
                            <i class="fas fa-cog fa-spin fa-2x text-primary"></i>
                            <h5 class="mt-2">Training in Progress...</h5>
                        </div>
                        <div class="progress mb-3">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div id="progressText" class="text-center text-muted">
                            Initializing training...
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" class="result-section">
                        <div class="text-center mb-3">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                            <h5 class="text-success">Training Completed!</h5>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card">
                                    <span id="processedCount" class="metric-number">0</span>
                                    <span class="metric-label">Images Processed</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card">
                                    <span id="facesCount" class="metric-number">0</span>
                                    <span class="metric-label">Faces Detected</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="font-weight-bold">Detection Accuracy:</label>
                            <div class="accuracy-meter">
                                <div id="accuracyFill" class="accuracy-fill" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <span id="accuracyText" class="font-weight-bold text-success">0%</span>
                                <small class="text-muted ml-2">(Faces detected / Images processed)</small>
                            </div>
                        </div>
                        
                        <div id="trainingMessage" class="mt-3 text-center">
                            <!-- Training message will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Error Section -->
                    <div id="errorSection" class="error-section">
                        <div class="text-center mb-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            <h5 class="text-danger">Training Failed</h5>
                        </div>
                        <div id="errorMessage" class="text-center">
                            <!-- Error message will be inserted here -->
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" onclick="resetTraining()">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Training form submission
    $('#trainingForm').on('submit', function(e) {
        e.preventDefault();
        startTraining();
    });
    
    // Status check
    $('#statusButton').on('click', function() {
        checkStatus();
    });
    
    function startTraining() {
        // Hide all sections and show progress
        hideAllSections();
        $('#progressSection').show();
        
        // Disable form
        $('#trainButton').prop('disabled', true);
        $('#statusButton').prop('disabled', true);
        
        // Start progress animation
        animateProgress();
        
        // Submit training request
        $.ajax({
            url: '{{ url_for("asset_training.train_model") }}',
            method: 'POST',
            data: $('#trainingForm').serialize(),
            timeout: 300000, // 5 minutes timeout
            success: function(response) {
                handleTrainingResponse(response);
            },
            error: function(xhr, status, error) {
                handleTrainingError(xhr, status, error);
            }
        });
    }
    
    function handleTrainingResponse(response) {
        // Re-enable form
        $('#trainButton').prop('disabled', false);
        $('#statusButton').prop('disabled', false);
        
        if (response.success) {
            // Show results
            hideAllSections();
            $('#resultsSection').show();
            
            // Update metrics
            $('#processedCount').text(response.processed_images || 0);
            $('#facesCount').text(response.faces_extracted || 0);
            
            // Calculate and show accuracy
            const processed = response.processed_images || 0;
            const faces = response.faces_extracted || 0;
            const accuracy = processed > 0 ? Math.round((faces / processed) * 100) : 0;
            
            $('#accuracyFill').css('width', accuracy + '%');
            $('#accuracyText').text(accuracy + '%');
            
            // Show training message
            $('#trainingMessage').html(`
                <div class="alert alert-success">
                    <strong>Success!</strong> ${response.message}
                </div>
            `);
            
            // Show success notification
            showNotification('success', 'Training completed successfully!');
            
        } else {
            // Show error
            hideAllSections();
            $('#errorSection').show();
            $('#errorMessage').text(response.error || 'Unknown error occurred');
            
            showNotification('danger', 'Training failed: ' + (response.error || 'Unknown error'));
        }
    }
    
    function handleTrainingError(xhr, status, error) {
        // Re-enable form
        $('#trainButton').prop('disabled', false);
        $('#statusButton').prop('disabled', false);
        
        // Show error
        hideAllSections();
        $('#errorSection').show();
        $('#errorMessage').text(`Request failed: ${status} - ${error}`);
        
        showNotification('danger', 'Training request failed');
    }
    
    function animateProgress() {
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90; // Stop at 90% until completion
            
            $('#progressBar').css('width', progress + '%').text(Math.round(progress) + '%');
            
            // Update progress text
            if (progress < 30) {
                $('#progressText').text('Loading and analyzing images...');
            } else if (progress < 60) {
                $('#progressText').text('Detecting faces in images...');
            } else if (progress < 90) {
                $('#progressText').text('Extracting face features...');
            } else {
                $('#progressText').text('Finalizing training process...');
                clearInterval(interval);
            }
        }, 500);
        
        // Store interval ID to clear it later
        window.trainingInterval = interval;
    }
    
    function hideAllSections() {
        $('#initialStatus').hide();
        $('#progressSection').hide();
        $('#resultsSection').hide();
        $('#errorSection').hide();
        
        // Clear any running intervals
        if (window.trainingInterval) {
            clearInterval(window.trainingInterval);
        }
    }
    
    function resetTraining() {
        hideAllSections();
        $('#initialStatus').show();
        $('#trainButton').prop('disabled', false);
        $('#statusButton').prop('disabled', false);
    }
    
    function checkStatus() {
        $.ajax({
            url: '{{ url_for("asset_training.training_status") }}',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const message = `Status: ${response.total_images} total images available (${response.real_images} real, ${response.ai_images} AI-generated)`;
                    showNotification('info', message);
                } else {
                    showNotification('warning', 'Status check failed: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                showNotification('danger', 'Status request failed');
            }
        });
    }
    
    function showNotification(type, message) {
        const alertClass = type === 'danger' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' :
                          type === 'info' ? 'alert-info' : 'alert-success';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        $('body').append(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});
</script>
{% endblock %}
